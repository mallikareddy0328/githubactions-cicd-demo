name: Build

on:
    push:
        branches:
            - main

jobs:
    build-scan:
        name: build job
        runs-on: self-hosted
        steps:
            - name: build
              uses: actions/checkout@v6
            #   with:
            #     fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
            - name: Build and analyse code scan
              uses: SonarSource/sonarqube-scan-action@master
              env:
                    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                    SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        
            - name: npm install dependencies
              run: npm install

            - name: Trivy file scan
              run: trivy fs . > trivyfs.txt

            - name : Docker Build and push
              run: |
                docker build -t tic-tac-toe .
                docker tag tic-tac-toe mallikareddy/tic-tac-toe:latest
                docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
                docker push mallikareddy/tic-tac-toe:latest

              env:
               DOCKER_CLI_ACI: 1

            - name : Image Scan
              run : trivy image mallikareddy/tic-tac-toe:latest > trivyimage.txt

    


